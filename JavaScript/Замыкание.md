В JavaScript у каждой выполняемой функции, блока кода `{...}` и скрипта есть связанный с ними внутренний (скрытый) объект, называемый _лексическим окружением_ `LexicalEnvironment`.

Объект лексического окружения состоит из двух частей:

1. _Environment Record_ – объект, в котором как свойства хранятся все локальные переменные (а также некоторая другая информация, такая как значение `this`).
    
2. Ссылка на _внешнее лексическое окружение_ – то есть то, которое соответствует коду снаружи (снаружи от текущих фигурных скобок).

Пример работы лексического окружения.

![[Pasted image 20250125215241.png]]

Функция – это тоже значение, как и переменная.

**Разница заключается в том, что Function Declaration мгновенно инициализируется полностью.**

Когда создается лексическое окружение, Function Declaration сразу же становится функцией, готовой к использованию (в отличие от `let`, который до момента объявления не может быть использован).

Именно поэтому мы можем вызвать функцию, объявленную как Function Declaration, до самого её объявления.

![[Pasted image 20250125214948.png]]

**Когда код хочет получить доступ к переменной – сначала происходит поиск во внутреннем лексическом окружении, затем во внешнем, затем в следующем и так далее, до глобального.**

```js
let phrase = 'hello';

function say(name) {
	console.log(phrase, name);
}

say('jon');
```

 как происходит поиск в нашем примере:

- Для переменной `name`, `alert` внутри `say` сразу же находит ее во внутреннем лексическом окружении.
- Когда `alert` хочет получить доступ к `phrase`, он не находит её локально, поэтому вынужден обратиться к внешнему лексическому окружению и находит `phrase` там.

![[Pasted image 20250126124800.png]]

Все функции помнят лексическое окружение, в котором они были созданы, так как все функции имеют скрытое свойство `[[Environment]]`, которое хранит ссылку на лексическое окружение, в котором была создана функция.

Замыкание - это функция, которая запоминает свое внешние окружение и может получить к нему доступ.  Все функции изначально являются замыканиями исключение,  в [Синтаксис "new Function"](https://learn.javascript.ru/new-function))(Но когда функция создаётся с использованием `new Function`, в её `[[Environment]]` записывается ссылка не на внешнее лексическое окружение, в котором она была создана, а на глобальное. Поэтому такая функция имеет доступ только к глобальным переменным.). То есть они автоматически запоминают, где были созданы, с помощью скрытого свойства `[[Environment]]`, и все они могут получить доступ к внешним переменным.
Все функции в JavaScript являются замыканиями, и, может быть, несколько слов о технических деталях: свойстве `[[Environment]]` и о том, как работает лексическое окружение.

Обычно лексическое окружение удаляется из памяти вместе со всеми переменными после завершения вызова функции. Это связано с тем, что на него нет ссылок. Как и любой объект JavaScript, оно хранится в памяти только до тех пор, пока к нему можно обратиться.

Однако если существует вложенная функция, которая все еще доступна после завершения функции, то она имеет свойство `[[Environment]]`, ссылающееся на лексическое окружение.

```js
function f() {
	let value = 123;
	
	return function() {
		alert(value);
	}
}

let g = f(); `// g.[[Environment]] хранит ссылку на лексическое окружение` `// из соответствующего вызова f()`
```

если `f()` вызывается много раз и результирующие функции сохраняются, то все соответствующие объекты лексического окружения также будут сохранены в памяти.

